<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Cenová kalkulácia Puella</title>
<style>
  /* --- ZÁKLADNÉ NASTAVENIA --- */
  @page { size: A4 landscape; margin: 0.8cm; }
  :root { 
      --pink: #e7318c; 
      --text: #1f2937; 
      --border: #e5e7eb; 
      --bg: #fafafa; 
      --blue-light: #eff6ff; 
      --blue-border: #3b82f6; 
      --gold: #d97706; 
      --gold-light: #fffbeb;
      --green-bg: #ecfdf5;
      --green-text: #047857;
      --red-alert: #ef4444;
  }
  * { box-sizing: border-box; }
  body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif; 
      color: var(--text); 
      background: #f3f4f6; 
      font-size: 13px; 
      margin: 0;
      padding: 10px;
      padding-bottom: 40px; 
      position: relative;
      min-height: 100vh;
  }
  
  .wrap { 
      max-width: 1280px; 
      margin: 0 auto; 
      background: #fff;
      border: 1px solid var(--border); 
      border-radius: 12px; 
      overflow: hidden; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
  }
  
  header { 
      padding: 15px 20px; 
      background: linear-gradient(180deg, rgba(231,49,140,.08), rgba(231,49,140,.01)); 
      border-bottom: 1px solid var(--border); 
  }
  h1 { font-size: 22px; margin: 0; color: var(--pink); }
  
  .section { padding: 20px; }
  .card { border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 20px; background: #fff; }
  
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  
  /* Inputy */
  input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; font-size: 13px; }
  input[type="number"] { text-align: center; font-weight: bold; }
  
  .inp-price {
      background: #fff;
      border: 1px solid #94a3b8;
      color: var(--pink);
      width: 80px !important;
      text-align: right;
      padding-right: 5px;
  }
  .inp-price:focus {
      border-color: var(--pink);
      outline: none;
      box-shadow: 0 0 0 2px rgba(231,49,140,0.2);
  }

  /* --- TABUĽKA --- */
  table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 5px; }
  th { 
      background: var(--pink); 
      color: #fff; 
      text-align: left; 
      padding: 10px 8px; 
      font-size: 12px; 
      text-transform: uppercase; 
      position: sticky; 
      top: 0; 
  }
  td { border-bottom: 1px solid #eee; padding: 8px; vertical-align: middle; }
  .right { text-align: right; }
  .center { text-align: center; }
  
  /* Typy produktov */
  tr.is-master td { background: var(--blue-light); border-top: 2px solid var(--blue-border); }
  tr.is-slave td { background: var(--blue-light); border-bottom: 2px solid var(--blue-border); color: #0f172a; }
  tr.is-master td:first-child { border-left: 4px solid var(--blue-border); }
  tr.is-slave td:first-child { border-left: 4px solid var(--blue-border); padding-left: 20px; }
  tr.is-premium td { background: var(--gold-light); border-top: 2px solid var(--gold); border-bottom: 2px solid var(--gold); }
  tr.is-premium td:first-child { border-left: 4px solid var(--gold); }
  
  .link-icon { color: var(--blue-border); font-size: 16px; margin-right: 4px; vertical-align: middle; font-weight: bold; }
  
  /* Odznaky */
  .badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 11px; border: 1px solid #ddd; display: inline-block; margin-top: 2px;}
  .tag-master { background: var(--blue-border); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-top: 2px;}
  .tag-slave { background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; border: 1px solid #93c5fd; display: inline-block; margin-top: 2px;}
  .tag-premium { background: var(--gold); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-top: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  
  /* Promo status */
  .promo-active { color: #047857; font-weight: bold; font-size: 11px; display: block; margin-top: 2px; }
  .promo-inactive { color: var(--red-alert); font-weight: bold; font-size: 11px; display: block; margin-top: 2px; }

  /* Varianty */
  .v-wrap { display: none; margin-top: 8px; border: 1px dashed #ccc; padding: 8px; background: #fff; border-radius: 4px; }
  .v-wrap.open { display: block; }
  .v-row { display: flex; justify-content: space-between; align-items: center; margin: 4px 0; font-size: 12px; }
  .v-btn { width: 28px; height: 28px; cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; color: #555; }
  .v-inp { width: 50px!important; text-align: center; margin: 0 5px; height: 28px; }
  .expand-btn { cursor: pointer; color: var(--pink); font-weight: bold; font-size: 12px; margin-left: 5px; text-decoration: underline; padding: 5px; display: inline-block;}

  /* --- NOVÉ ŠTÝLY PRE EMAIL FORMULÁR --- */
  .label { font-weight: bold; margin-bottom: 5px; display: block; color: var(--text); }
  .note { font-size: 12px; color: #6b7280; margin-bottom: 15px; margin-top:0; }
  .btn { 
      padding: 10px 20px; 
      background: #1f2937; 
      color: #fff; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-weight: bold;
      font-size: 14px;
      transition: background 0.2s;
  }
  .btn:hover { background: #374151; }
  .inline { display: flex; align-items: center; gap: 10px; }
  
  .main-footer {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      padding: 20px;
      margin-top: 20px;
      border-top: 1px solid #e5e7eb;
      width: 100%;
  }

  /* --- MOBIL --- */
  @media only screen and (max-width: 768px) {
      body { padding: 5px; padding-bottom: 60px; }
      .section { padding: 10px; }
      .grid { grid-template-columns: 1fr; gap: 10px; }
      input[style*="width:60%"] { width: 100% !important; margin-top: 5px; }
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); background: #fff; padding-bottom: 10px; }
      tr.is-master { background: var(--blue-light); border: 2px solid var(--blue-border); border-bottom: none; border-radius: 8px 8px 0 0; margin-bottom: 0; }
      tr.is-slave { background: var(--blue-light); border: 2px solid var(--blue-border); border-top: none; border-radius: 0 0 8px 8px; margin-top: -2px; }
      tr.is-premium { background: var(--gold-light); border: 2px solid var(--gold); border-radius: 8px; }
      tr.is-master td:first-child, tr.is-slave td:first-child, tr.is-premium td:first-child { border-left: none; }
      td { border: none; border-bottom: 1px solid #f0f0f0; position: relative; padding-left: 45%; text-align: right; padding-top: 10px; padding-bottom: 10px; min-height: 40px; }
      td:last-child { border-bottom: none; }
      td:before { position: absolute; top: 10px; left: 10px; width: 40%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: #666; content: attr(data-label); }
      td:first-child { padding-left: 10px; text-align: left; background: #f9fafb; border-bottom: 2px solid #eee; font-size: 15px; }
      td:first-child:before { content: none; }
      .v-wrap { position: relative; width: 100%; text-align: left; margin-top: 15px;}
      tfoot tr { display: flex; flex-direction: column; align-items: flex-end; padding: 10px; border:none; box-shadow: none; background: transparent; }
      tfoot td { padding-left: 10px; text-align: right; width: 100%; display: flex; justify-content: space-between;}
      tfoot td:before { position: static; width: auto; }
      
      /* Úprava formulára pre mobil */
      #orderForm { grid-template-columns: 1fr !important; gap: 15px !important; }
      .btn { width: 100%; padding: 15px; }
      .inline { flex-direction: column; align-items: stretch; }
  }
  @media print {
    .btn, .expand-btn, .v-btn, #orderForm, .label, .note, .card:last-of-type { display: none !important; }
    .v-wrap { display: block !important; border: none; padding: 0; }
    input { border: none; background: none; padding: 0; }
    .inp-price { border: none !important; text-align: right; width: auto !important; padding: 0; }
    tr.is-master td, tr.is-slave td { background-color: #f0f8ff !important; -webkit-print-color-adjust: exact; }
    tr.is-premium td { background-color: #fef3c7 !important; -webkit-print-color-adjust: exact; }
    table, thead, tbody, th, td, tr { display: table-row-group; }
    thead { display: table-header-group; }
    tr { display: table-row; border: none; margin: 0; box-shadow: none; }
    td { display: table-cell; padding: 6px; text-align: left; border-bottom: 1px solid #eee; }
    .right { text-align: right; }
    .center { text-align: center; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Cenová kalkulácia Puella</h1>
  </header>

  <div class="section">
    <div class="card">
      <div class="grid">
        <div><strong>Dodávateľ:</strong> PUELLAvone s. r. o., Košice</div>
        <div><strong>Odberateľ:</strong> <input id="customerName" placeholder="Doplňte údaje klienta..." style="width:60%;display:inline-block"></div>
      </div>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:30%">Produkt</th>
            <th class="right" style="width:12%">MOC s DPH<br>(Editovateľné)</th>
            <th class="right" style="width:10%">Marža<br>(%)</th>
            <th style="width:10%">Poznámka</th>
            <th class="center" style="width:15%">Počet</th>
            <th class="right" style="width:12%">Vaša Cena<br>bez DPH / ks</th>
            <th class="right" style="width:13%">Spolu nákup<br>bez DPH</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr><td colspan="6" class="right" data-label="Základ"><strong>Spolu bez DPH</strong></td><td class="right" id="sum_wo">0,00 €</td></tr>
          <tr><td colspan="6" class="right" data-label="DPH">DPH 23%</td><td class="right" id="sum_vat">0,00 €</td></tr>
          <tr><td colspan="6" class="right" data-label="Celkom"><strong style="color:var(--pink);font-size:14px">Spolu s DPH</strong></td><td class="right" id="sum_w" style="font-weight:bold;font-size:15px">0,00 €</td></tr>
          <tr>
            <td colspan="7" class="center" style="background:var(--green-bg);color:var(--green-text);padding:10px;border-top:1px solid #10b981">
              <strong>Potenciálny zisk z predaja (bez DPH): <span id="profit">0,00 €</span></strong>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="card">
      <div class="label" style="font-size:16px; margin-bottom:8px;">Odoslanie objednávky e-mailom</div>
      <p class="note">Formulár odošle súhrn vyplnených položiek (vrátane poznámok) na zadaný e-mail.</p>
      
      <form id="orderForm" action="https://formspree.io/f/myzdbgol" method="POST" onsubmit="prepareOrder()" style="display:grid;gap:10px;grid-template-columns:1fr 240px;align-items:end">
        <div>
          <label class="label" for="orderEmail" style="text-transform:none;color:var(--text)">E-mail na potvrdenie</label>
          <input id="orderEmail" name="email" type="email" placeholder="vas@email.sk" style="width:100%" required>
        </div>
        <button type="submit" class="btn">Odoslať objednávku e-mailom</button>

        <textarea name="message" id="orderMessage" hidden></textarea>
        <input type="hidden" name="_subject" id="orderSubject" value="Nová Objednávka (Puella Kalkulácia)">
      </form>
    </div>

  </div>
  
  <footer class="main-footer">
      Vytvoril: Matúš Benčo | +421 918 830 701
  </footer>
</div>

<script>
const fmt = n => n.toLocaleString('sk-SK',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' €';
const pct = n => n.toLocaleString('sk-SK',{minimumFractionDigits:1,maximumFractionDigits:1}) + ' %';

// --- DÁTA ---
const data = [
  // --- 1. SET 500ml ---
  {
    id: 'p500', 
    name: 'Puella parfum 500 ml', 
    nc: 14.90, // Základná cena
    nc_discount: 13.09, // Zľavnená cena
    moc: 25.90, 
    vars: true,
    type: 'master', 
    slave: 'gel1000',
    badge: 'Podmienka: Nákup s gélom',
    promoInfo: 'Akcia: Balenie 11ks = 13,09 €/ks'
  },
  {
    id: 'gel1000', 
    name: 'Prací gél 1000 ml', 
    nc: 5.00,  
    moc: 9.90, 
    vars: true, 
    customVars: ['Univerzálny', 'Biele prádlo', 'Čierne prádlo'],
    type: 'slave',
    master: 'p500',
    badge: 'Povinný doplnok'
  },

  // --- 2. SET 250ml ---
  {
    id: 'p250', 
    name: 'Puella parfum 250 ml', 
    nc: 13.68, 
    moc: 19.90, 
    vars: true,
    type: 'master', 
    slave: 'strips10',
    badge: 'Podmienka: Nákup s pásikmi'
  },
  {
    id: 'strips10', 
    name: 'Pásiky na pranie (10 ks)', 
    nc: 2.00, 
    moc: 3.90, 
    vars: false, 
    type: 'slave',
    master: 'p250',
    badge: 'Povinný doplnok'
  },

  // --- 3. PARFUM NA TELO 50ml ---
  {
    id: 'p50_single', 
    name: 'Parfum na telo 50 ml (Kus)', 
    nc: 12.07, 
    moc: 19.90, 
    vars: true,
    badge: 'Novinka'
  },
  {
      id: 'p50_pack', 
      name: 'Parfum na telo 50 ml (6-pack)', 
      nc: 60.36, 
      moc: 119.90, 
      vars: true,
      customVars: ['Double', 'Frayo', 'Emija', 'JaLu', 'Quenka', 'First Dream'], 
      type: 'premium', 
      badge: 'VÝHODNÉ BALENIE (Sada 6ks)'
  },

  // --- 4. Ostatné produkty ---
  {id:'sample', name:'Skúšobný set (6 ks)', nc:1.62, moc:3.50},
  
  {id:'s10', name:'Pásiky na pranie - 10 ks (Samostatné)', nc:2.84, moc:4.99},
  {id:'s50', name:'Pásiky na pranie - 50 ks', nc:8.84, moc:15.99},
  {id:'s100', name:'Pásiky na pranie - 100 ks', nc:13.21, moc:24.99},
  
  {id:'cl250', name:'Univerzálny čistič 250 ml', nc:3.69, moc:6.99, vars:true},
  {id:'cl500', name:'Univerzálny čistič 500 ml', nc:5.28, moc:9.99, vars:true},
  
  {id:'candle', name:'Vonná sviečka 230g', nc:6.21, moc:11.90, vars:true, note:'Akcia 1+1'},
  {id:'diff', name:'Vonný difuzér 100ml', nc:8.22, moc:14.90, vars:true, note:'Akcia 1+1'},
  {id:'card', name:'Voňavá karta', nc:2.70, moc:4.90, vars:true},
  {id:'p10', name:'Parfum 10ml', nc:6.34, moc:12.90, vars:true}
];

const stdVars = ['Double', 'Frayo', 'Emija', 'JaLu', 'Quenka', 'First Dream'];
const state = {};

// Inicializácia
data.forEach(p => {
  state[p.id] = {};
  const vList = p.customVars || stdVars;
  if(p.vars) vList.forEach(v => state[p.id][v] = 0);
  else state[p.id]['_val'] = 0;
});

function render(){
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';

  data.forEach(p => {
    let trClass = '';
    if(p.type === 'master') trClass = 'is-master';
    if(p.type === 'slave') trClass = 'is-slave';
    if(p.type === 'premium') trClass = 'is-premium'; 

    const tr = document.createElement('tr');
    tr.className = trClass;

    let nameHtml = `<strong>${p.name}</strong>`;
    if(p.type === 'slave') nameHtml = `<span class="link-icon">↳</span> ${p.name}`;
    
    let badgeHtml = '';
    if(p.badge) {
        let bClass = 'badge';
        if(p.type === 'master') bClass = 'tag-master';
        if(p.type === 'slave') bClass = 'tag-slave';
        if(p.type === 'premium') bClass = 'tag-premium';
        badgeHtml = `<br><span class="${bClass}">${p.badge}</span>`;
    }
    if(p.promoInfo) {
         badgeHtml += `<br><span class="badge" style="background:#fee2e2;color:#b91c1c;border:1px solid #fca5a5;margin-top:2px">${p.promoInfo}</span>`;
    }
    if(p.note) badgeHtml += ` <span class="badge">${p.note}</span>`;

    const totalQty = getQty(p.id);
    let inputHtml = '';
    
    if(p.vars) {
      let btnText = p.type === 'premium' ? '▼ Vybrať balenia' : '▼ Vybrať varianty';
      let unitText = p.type === 'premium' ? 'bal.' : 'ks';
      
      inputHtml = `
        <div class="center">
          <span id="qty-total-${p.id}" style="font-weight:bold;font-size:14px">${totalQty} ${unitText}</span>
          <span class="expand-btn" onclick="toggle('${p.id}')">${btnText}</span>
          <div id="status-${p.id}"></div>
          <div id="promo-status-${p.id}"></div>
        </div>
        <div id="wrp-${p.id}" class="v-wrap">
          ${renderVars(p)}
        </div>
      `;
    } else {
      let readonly = p.type === 'slave' ? 'readonly style="background:#eee;color:#555"' : '';
      inputHtml = `<input id="inp-simple-${p.id}" type="number" value="${totalQty}" min="0" onchange="updSimple('${p.id}',this.value)" ${readonly}>`;
    }

    const mocInput = `<input type="number" step="0.01" class="inp-price" value="${p.moc}" onchange="updMoc('${p.id}', this.value)"> €`;
    const priceDisplay = `<span id="price-unit-${p.id}">${fmt(p.nc)}</span>`;

    tr.innerHTML = `
      <td data-label="Produkt">${nameHtml}${badgeHtml}</td>
      <td class="right" data-label="MOC s DPH">${mocInput}</td>
      <td class="right" data-label="Marža" id="margin-${p.id}" style="color:#059669;font-weight:bold">-</td>
      <td data-label="Poznámka"><input id="note-${p.id}" type="text" placeholder="Pozn." style="border:none;border-bottom:1px dashed #ccc; width:100%"></td>
      <td data-label="Počet">${inputHtml}</td>
      <td class="right" data-label="Cena bez DPH">${priceDisplay} / ${p.type==='premium'?'bal':'ks'}</td>
      <td class="right" id="sum-${p.id}" data-label="Spolu bez DPH" style="font-weight:600">${fmt(0)}</td>
    `;
    tb.appendChild(tr);
  });
  recalc();
}

function renderVars(p){
  const vList = p.customVars || stdVars;
  return vList.map(v => `
    <div class="v-row">
      <span style="flex:1">${v}</span>
      <div style="display:flex;align-items:center">
        <button class="v-btn" onclick="chV('${p.id}','${v}',-1)">-</button>
        <input id="inp-${p.id}-${v}" class="v-inp" type="number" value="${state[p.id][v]}" onchange="setV('${p.id}','${v}',this.value)">
        <button class="v-btn" onclick="chV('${p.id}','${v}',1)">+</button>
      </div>
    </div>
  `).join('');
}

function toggle(id){ document.getElementById(`wrp-${id}`).classList.toggle('open'); }
function getQty(id){ return Object.values(state[id]).reduce((a,b)=>a+b,0); }

function chV(id, v, d){
  const p = data.find(x=>x.id===id);
  if(p.type === 'slave' && d > 0){
    const mQty = getQty(p.master);
    const cQty = getQty(id);
    if(cQty >= mQty) return alert('Nemôžete pridať viac kusov doplnku ako máte hlavných produktov.');
  }
  const val = Math.max(0, state[id][v] + d);
  state[id][v] = val;
  document.getElementById(`inp-${id}-${v}`).value = val;
  recalc();
}

function setV(id, v, val){
  const p = data.find(x=>x.id===id);
  let n = parseInt(val)||0;
  if(n<0) n=0;
  if(p.type === 'slave'){
     const mQty = getQty(p.master);
     const cQty = getQty(id);
     const old = state[id][v];
     if((cQty - old + n) > mQty){
       alert('Prekročený počet doplnkov!');
       n = old;
     }
  }
  state[id][v] = n;
  document.getElementById(`inp-${id}-${v}`).value = n;
  recalc();
}

function updSimple(id, val){
  state[id]['_val'] = parseInt(val)||0;
  recalc();
}

function updMoc(id, val) {
    let cleanVal = val.replace(',', '.');
    let n = parseFloat(cleanVal);
    if(isNaN(n)) n = 0;
    const p = data.find(x => x.id === id);
    if(p) { p.moc = n; recalc(); }
}

function recalc(){
  let totalNC = 0;
  let totalProfit = 0;
  
  data.forEach(p => {
    const qty = getQty(p.id);
    
    // --- Logika ceny pre Puella 500ml (Násobky 11) ---
    let currentNC = p.nc;
    if(p.id === 'p500') {
        const remainder = qty % 11;
        const isBulk = (qty > 0 && remainder === 0);
        currentNC = isBulk ? p.nc_discount : p.nc;
        
        const priceUnitEl = document.getElementById(`price-unit-${p.id}`);
        if(priceUnitEl) {
            priceUnitEl.innerHTML = fmt(currentNC);
            if(isBulk) {
               priceUnitEl.style.color = '#047857'; // Zelená
               priceUnitEl.style.fontWeight = 'bold';
            } else {
               priceUnitEl.style.color = 'inherit';
            }
        }

        const promoEl = document.getElementById(`promo-status-${p.id}`);
        if(promoEl) {
            if (qty === 0) {
                promoEl.innerHTML = '';
            } else if (isBulk) {
                promoEl.innerHTML = `<span class="promo-active">✓ ZĽAVA 11+ AKTÍVNA</span>`;
            } else {
                const missing = 11 - remainder;
                const nextTarget = qty + missing;
                promoEl.innerHTML = `<span class="promo-inactive">Pre zľavu objednajte ${nextTarget} ks (chýba ${missing})</span>`;
            }
        }
    }
    
    const rowNC = qty * currentNC;
    document.getElementById(`sum-${p.id}`).innerText = fmt(rowNC);
    if(p.vars) {
        let unitText = p.type === 'premium' ? 'bal.' : 'ks';
        document.getElementById(`qty-total-${p.id}`).innerText = qty + ' ' + unitText;
    }

    let marginText = '-';
    let rowProfit = 0;
    if(p.moc > 0) {
      // OPRAVA ZISKU: (MOC s DPH / 1.23) - Nákup bez DPH
      const mocBezDPH = p.moc / 1.23;
      const ziskKus = mocBezDPH - currentNC;
      rowProfit = ziskKus * qty;
      totalProfit += rowProfit;

      // Marža počítaná zo základu dane (Netto)
      if (mocBezDPH > 0) {
          let m = (ziskKus / mocBezDPH) * 100;
          marginText = pct(m);
      }
    }
    
    const marginEl = document.getElementById(`margin-${p.id}`);
    if(marginEl) {
        marginEl.innerText = marginText;
        marginEl.style.color = (marginText !== '-' && parseFloat(marginText) < 0) ? '#dc2626' : '#059669';
    }

    if(p.type === 'master'){
      const sId = p.slave;
      const sP = data.find(x=>x.id===sId);
      if(!sP.vars){
        state[sId]['_val'] = qty;
        const el = document.getElementById(`inp-simple-${sId}`);
        if(el) el.value = qty;
        document.getElementById(`sum-${sId}`).innerText = fmt(qty * sP.nc);
      } else {
          updateSlaveStatus(sP);
      }
    }
    if(p.type === 'slave' && p.vars) updateSlaveStatus(p);

    totalNC += rowNC;
  });

  const vat = totalNC * 0.23;
  document.getElementById('sum_wo').innerText = fmt(totalNC);
  document.getElementById('sum_vat').innerText = fmt(vat);
  document.getElementById('sum_w').innerText = fmt(totalNC + vat);
  
  const profitEl = document.getElementById('profit');
  profitEl.innerText = fmt(totalProfit);
  profitEl.style.color = totalProfit >= 0 ? '#047857' : '#dc2626';
}

function updateSlaveStatus(p) {
    const totalQty = getQty(p.id);
    const mQty = getQty(p.master);
    const diff = mQty - totalQty;
    const statusEl = document.getElementById(`status-${p.id}`);
    
    if(statusEl) {
        if(diff > 0) statusEl.innerHTML = `<div style="color:#dc2626;font-weight:bold;font-size:11px;margin-top:2px">Vyberte ešte: ${diff} ks</div>`;
        else if (diff < 0) statusEl.innerHTML = `<div style="color:#dc2626;font-weight:bold;font-size:11px;margin-top:2px">Navyše: ${Math.abs(diff)} ks</div>`;
        else if (totalQty > 0) statusEl.innerHTML = `<div style="color:#16a34a;font-weight:bold;font-size:11px;margin-top:2px">✓ KOMPLETNÉ</div>`;
        else statusEl.innerHTML = '';
    }
}

// Funkcia na prípravu e-mailu pred odoslaním
function prepareOrder() {
    let customer = document.getElementById('customerName').value || 'Neuvedené';
    let emailText = "OBJEDNÁVKA PUELLA\n";
    emailText += "----------------------------\n";
    emailText += "Odberateľ: " + customer + "\n";
    emailText += "Dátum: " + new Date().toLocaleDateString('sk-SK') + "\n\n";
    emailText += "POLOŽKY:\n";
    
    let totalSum = 0;
    
    data.forEach(p => {
        let qty = getQty(p.id);
        if (qty > 0) {
            let note = document.getElementById(`note-${p.id}`).value;
            // Zistenie aktuálnej ceny (kvôli zľave 11ks)
            let currentNC = p.nc;
            if(p.id === 'p500') {
                 if(qty > 0 && (qty % 11 === 0)) currentNC = p.nc_discount;
            }
            let rowPrice = qty * currentNC;
            totalSum += rowPrice;
            
            let unitLabel = p.type==='premium'?'bal':'ks';
            emailText += `\n• ${p.name} (${qty} ${unitLabel})`;
            
            if (p.vars) {
                 let variantsStr = [];
                 const vList = p.customVars || stdVars;
                 vList.forEach(v => {
                     let vQty = state[p.id][v];
                     if(vQty > 0) variantsStr.push(`${v}: ${vQty}`);
                 });
                 if(variantsStr.length > 0) emailText += `\n   Variatny: [ ${variantsStr.join(', ')} ]`;
            }
            
            emailText += `\n   Cena/j: ${fmt(currentNC)} | Spolu: ${fmt(rowPrice)}`;
            if(note) emailText += `\n   Poznámka: ${note}`;
            emailText += "\n";
        }
    });
    
    let vat = totalSum * 0.23;
    let totalWithVat = totalSum + vat;
    let profitTxt = document.getElementById('profit').innerText;

    emailText += "\n----------------------------\n";
    emailText += "SÚHRN:\n";
    emailText += "Spolu bez DPH: " + fmt(totalSum) + "\n";
    emailText += "DPH 23%: " + fmt(vat) + "\n";
    emailText += "SPOLU S DPH: " + fmt(totalWithVat) + "\n";
    emailText += "Potenciálny zisk (bez DPH): " + profitTxt + "\n";
    
    document.getElementById('orderMessage').value = emailText;
}

render();
</script>
</body>
</html>
